var ecoFuturoApp;$(document).ready(function(){"use strict";ecoFuturoApp={init:function(){var e=this;this.setVideoSize();this.setMap();this.bindEvents();this.bindScroll();this.bindForms();this.fixBugs();this.GASetup();$("[data-modal]").on("click",function(t){t.preventDefault();var n=$(this).data("modal-target");e.showModal(n)})},GASetup:function(){var e=this;$("[data-ga]").on("click",function(t){var n=$(this).data("ga");if(n){var r=n.events?n.events:[n];$.each(r,function(t,n){e.addGAEvent(n)})}})},addGAEvent:function(e){var t;if(e.type=="pageview"){var t=e;ga("send","pageview",e.data)}else{t={hitType:e.type||"event",eventCategory:e.category,eventAction:e.action,eventLabel:e.label,eventValue:e.value||null};ga("send",t)}console.log("%c Enviando dados para [GA]","color: #FF6B6B; font-weight:bold;");console.log("%c %s","color: #6B75FF; font-style: italic;",JSON.stringify(t))},fixBugs:function(){if(navigator.userAgent.match(/win(dows?)/ig)){s=document.createElement("style");s.innerHTML="section#home .header .text-header,section.section>article>header>h1{font-family:open_sansbold,sans-serif}section#sobre-o-projeto .box-about{font-family:open_sansbold,sans-serif}section#sobre-o-projeto article#boxes-wrapper .boxes .box header{font-family:open_sansbold,sans-serif}#oriente-se .boxes,.button,section#resultados .results-wrapper ul.results-counts li,section#resultados .results-wrapper ul.results-counts li.header{font-family:open_sansbold,sans-serif}footer.footer .footer-section section header>*{text-align:left;font-family:open_sansbold,sans-serif}.form .radio-wrapper label{top:1px;left:1px;right:1px;bottom:1px;cursor:pointer;font-family:open_sansbold,sans-serif}#signup_form .signup-steps-wrapper .signup_form .submit-field .back-button,#signup_form .signup-steps-wrapper .signup_form .submit-field input[type=submit],#signup_form>header>h1,.form .field-wrapper input[type=submit],.section.contact .contact-form-wrapper header{font-family:open_sansbold,sans-serif}";$("head").append(s)}},showModal:function(e){var t=this;var n=$("#modal"),r=n.width();t.setBGMask(true,0,"#modal");n.css({width:r+"px",left:"50%","margin-left":-(r/2)+"px"});$(".modal-content .inner-content").hide(function(){$(e).show();n.fadeIn(function(){t.scrollTo(n,undefined,function(){$("body,html").finish()})})})},bindForms:function(){var e=this;this.submitForm("#new_library_form",{pre_send:function(t){var n=$("input[type='submit']",t).first();n.attr("disabled","disabled");n.attr("data-last-value",n.val());n.val("Enviando...");e.addGAEvent({type:"event",category:"formulário de cadastro",action:"ir para",label:"cadastrar"})},success:function(t,n){var r=$("input[type='submit']",t).first();$(t).slideUp();r.removeAttr("disabled");r.val(r.attr("data-last-value"));$("#signup_step_3").slideDown();e.addGAEvent({type:"pageview",data:{page:"/inscreva-se/cadastrar/cadastro concluído"}})},error:function(e,t){}},true,undefined,false);this.submitForm("#contact_form",{success:function(){$("#contact_section").slideUp().remove()},error:function(){}},true);$("#search_query").on("keydown",function(){if($(this).val()==""){e.clearMarkers();e.createMarkersCluster(e.markers)}});this.submitForm("#search_form",{pre_send:function(){e.addGAEvent({type:"event",category:"mapa",action:"buscar",label:$("#search_query").val()})},success:function(t,n){if(n.success&&n.total_records>0){var r,i=[];var s=$.map(n.libraries,function(e,t){return e._id});$.each(e.markers,function(e,t){var n=s.indexOf(t.__id)!=-1;if(n){i.push(t)}if(n&&!r)r=t});var o=e.markers;e.clearMarkers();e.markers=o;e.createMarkersCluster(i);if(r){e.map.setCenter(r.position);e.map.setZoom(4)}e.setBGMask(false)}else{e.showNotification({message:"Nenhuma biblioteca encontrada para sua busca",header:"Opss :("},"error")}},error:function(t,n){var r={message:n.errors.query,header:"Erro na busca"};e.showNotification(r,"error")}})},setBGMask:function(e,t,n){var r=$("#background-mask"),i=e?"fadeIn":"fadeOut";r.attr("data-target",n);if(i=="fadeOut"){$("#modal").hide()}return r.delay(t||0)[i].call(r,"fast")},submitForm:function(e,t,n,r,i){var s=this;$(e).on("submit",function(e){e.preventDefault();var o=$(this);var u=r||o.attr("method")||"POST";if(t.pre_send&&typeof t.pre_send=="function"){t.pre_send.call(null,o)}$.ajax({url:$(o).attr("action"),data:$(o).serialize(),type:u,dataType:"json",success:function(e){if(e.success){if(t.success)t.success(o,e)}else if(e.error){if(t.error)t.error(o,e)}if(n){if(e.error){if(typeof e.errors=="object"){var r=Object.keys(e.errors).map(function(t){return e.errors[t]});var i=r.map(function(t){return"<li>"+t+"</li>"}).join("")}else{i=e.message}e.message=["<ul class='errors-messages'>",i,"</li>"].join("");e.header="Opss"}else if(e.success){e.header="Sucesso!"}var u=e.error?"error":"success";s.showNotification(e,u)}},fail:function(){s.showNotification({message:"Um erro ocorreu em nossos servidores. Por favor, tente novamente ou volte mais tarde.",header:"Erro interno"},"error",true)},complete:function(){if(i!==false){s.setBGMask(false,2e3)}},beforeSend:function(){s.setBGMask(true)}})})},showNotification:function(e,t,n){var r=this;r.formLogger=$("#form-logger");r.formLogger.removeAttr("class");r.formLogger.addClass(t);r.formLogger.find(".message-header").html(e.header);r.formLogger.find(".message-body").html(e.message);r.formLogger.css({"margin-top":-(r.formLogger.height()/2)+"px","margin-left":-(r.formLogger.width()/2)+"px",position:"fixed"});r.formLogger.fadeIn().animate({top:"50%",opacity:"1"},function(){setTimeout(function(){r.formLogger.animate({top:"-50%"},function(){$(this).css({"margin-top":"0"}).fadeOut("fast")})},n||1e3)})},setVideoSize:function(){var e=$(window).width();var t=$("section#home");var n=$("#preview-video");n.show();if(e<1024||!n.is(":visible")){t.removeAttr("style");n.hide();return false}var r=n.height()+"px";t.css("height",r)},bindEvents:function(){var e=this;this.bindShareEvents();$(".scroll-button").on("click",function(t){t.preventDefault();var n=$(this).data("target");e.scrollTo(n)});$(window).resize(function(){e.setVideoSize()});var t=$("#preview-video-wrapper");if($.browser.mobile==true){t.remove()}$("#video-play").on("click",function(){var e=$(this),n=$("#video");e.fadeOut("slow");var r=n.attr("src");n.attr("src",r+"&autoplay=1");$(".text-header,.share-text,.down-button","#home").delay(200).fadeOut("fast",function(){$("#video-wrapper").fadeIn(function(){if(t.size()>0){t.fadeOut()}})})});$("#background-mask").on("click",function(){var t=$($(this).data("target"));e.setBGMask(false);t.fadeOut()});this.bindMenu();this.bindContactForm();this.bindBoxes();this.bindSignupForm()},bindMenu:function(){var e=this;$("#main-menu, #footer-links").on("click","li > a",function(t){e.scrollTo($(this).attr("href"),500)})},bindContactForm:function(){var e=this,t=$("#contact_form .step").size();e.contactStep=1;var n=$(".contact-form-wrapper #back-btn");n.fadeOut();$(".contact-form-toggle").on("click",function(t){t.preventDefault();var n=$("#contact_section");n.slideToggle();var r=$(".step#step_"+e.contactStep);r.fadeIn();e.scrollTo(n)});var r=function(){var r=$(".step#step_"+e.contactStep);r.fadeOut(function(){var r=$(".step#step_"+(e._previousContact?--e.contactStep:++e.contactStep));if(r.size()>0&&(e._previousContact?e.contactStep>=1:e.contactStep<=t)){r.fadeIn();if(e.contactStep>1){n.fadeIn()}else{n.hide()}e._previousContact=false;e.scrollTo(r)}})};$(".step input[type='radio']").on("change, click",function(e){r()});$(n).on("click",function(t){t.preventDefault();e._previousContact=true;return r()})},bindSignupForm:function(){var e=this,t=$("#signup_form");$("button.signup, a.signup").on("click",function(){e.setBGMask(true,null,"#signup_form");e.scrollTo("#map-wrapper",undefined,function(){$("#new_library_form").fadeIn();$("#signup_step_3").fadeOut();t.slideDown("fast")})});$("#signup_step_1").on("change",'input[type="radio"]',function(e){var t=$("#signup_type"),n=$(this),r=n.data("header"),i=n.val();if(t.html()!=r){t.html(r)}$("[class*='signup_type_']","#signup_form").hide();$(".signup_type_"+i).show()});var n=$("#autocomplete-wrapper"),r=$("#autocomplete-results",n),i=false;r.hover(function(){i=true},function(){i=false});$(r).on("click","li",function(){var e=$(this);$("#library_institution_name").val(e.data("value"));$("#library_school_id").val(e.data("id"));$(n,r).fadeOut("fast");$("#signup_form").removeClass("autocomplete-opened")});var s=function(){r.children("li").remove()};var o=function(){var e=$("#library_institution_name").val(),t=$("select#library_state").val(),n=$("select#library_city").val();return{address:{city:{name:n},district:{name:t},number:"",street:n},label:"Cadastrar "+e,name:e}};var u=function(e){var t=$(document.createDocumentFragment());$.each(e.schools,function(e,n){var r=[n.label||n.name," - ",n.address.street,", ",n.address.district.name].join("");var i=$(document.createElement("li")).attr({"data-id":n._id,"data-value":n.name});var s=$("<span />",{"class":"value",html:r}).appendTo(i);t.append(i)});return r.append(t)};var a=function(e){var t=$("#signup_form"),i="autocomplete-opened";s();if(e&&e.success&&e.count>0){t.addClass(i);r.fadeIn();e.schools.unshift(o());u(e)}else{n.fadeIn();r.fadeIn();return u({schools:[o()]})}};e.autoCompleteCache={};$("#library_institution_name").on("blur",function(e){if(i){return false}$("#signup_form").removeClass("autocomplete-opened");r.fadeOut()});var f=Date.now();$("#library_institution_name").on("change keyup",function(){var t=$("select#library_state").val(),n=$("select#library_city").val();if(!t){return e.showNotification({message:"Você deve selecionar o estado e a cidade antes de pesquisar a escola.",header:"Ops..."},"error",2e3)}else if(!n){return e.showNotification({message:"Você deve selecionar uma cidade antes de pesquisar a escola",header:"Ops..."},"error",1600)}var r=$(this),i=r.val();if(i.length<3){return s()}var o=(Date.now()-f)/1e3;var u=[t,n,i].join("_");var l=!!e.autoCompleteCache[u];if(l||o>=.3){f=Date.now();if(l){a(e.autoCompleteCache[u])}else{$.get("/api/schools/autocomplete",{city:n,state:t,name:i},function(t){e.autoCompleteCache[u]=t;a(t)},"json")}}else{}});$("#signup_step_1 input[type='radio']:checked").change();var l=new dgCidadesEstados({estado:$(t).find(".state-select").get(0),cidade:$(t).find(".city-select").get(0)})},bindBoxes:function(){var e=$("#boxes-wrapper"),t=$("#boxes_nav"),n=$("#arrow_nav"),r=$("#text-slide-wrapper"),i=0;t.on("click","li",function(){var e=$(this).index();s(e);clearInterval(u)});var s=function(e){$("li",t).removeClass("current");$("li",t).eq(e).addClass("current");var n=$("#slide-texts li.current").outerHeight();r.css({height:n+"px"});$("#slide-texts").css("position","relative").animate({top:-(e*n)},200)};var o=function(){s(i++);if(i>=3){i=0}};s(t.find("li:first").index());var u=setInterval(o,8e3);$(".box",e).on("click",function(){var t=$(this),r=t.index();if(t.hasClass("opened")){return false}var i=$(".opened",e);i.removeClass("opened");$(this).addClass("opened");var s=["15%","50%","85%"];var o=[{category:"porque ter uma biblioteca"},{category:"o que diz a lei"},{category:"linhas de ação"}];n.animate({left:s[r]},function(){var e=$("#box-desc-contents > ul.contents").find("> li").get(r);$("#desc-content").html($(e).html());var t=o[r];$(".share .share-icons li a").each(function(e,n){n=$(n);var r=n.data("ga");$.extend(r,t);n.attr("data-ga",JSON.stringify(r))})})});$(".box.first").click()},scrollTo:function(e,t,n){var r=Math.max.apply(Math,[$(e).offset().top-170,0]);$("html, body").animate({scrollTop:r},t==undefined?1e3:t,n==undefined?function(){}:n)},bindShareEvents:function(){$(".facebook-share").on("click",function(e){e.preventDefault();FB.ui({method:"feed",link:CURRENT_HOST},function(e){})});$("nav.banners .banner").on("click","a",function(e){e.preventDefault();var t=$(this);$("article.embed-code").slideDown("fast",function(){$("#embed_code").html(t.parent("li").html().trim())})});var e="http://goo.gl/8oO9u8";$("#boxes-wrapper .share-icons").on("click","a",function(t){t.preventDefault();var n="";var r=$(this).parent("li"),i="",s="";$("#desc-content ul > li").each(function(e,t){n+=$(t).text().trim()+" "});n=n.replace(/\n/g,"").replace(/\s{5,}/g,"");var o=$(this).parents("#boxes-wrapper");o.find(".boxes li").each(function(e,t){if($(".boxes li").eq(e).hasClass("opened")){switch(e){case 0:s="Conheça mais sobre os objetivos da campanha Eu Quero Minha Biblioteca.";i="Conheça mais sobre os objetivos da campanha Eu Quero Minha Biblioteca em http://goo.gl/8oO9u8";break;case 1:s="Saiba mais sobre a Lei 12.244/10, que garante o direito a biblioteca em todas as instituições de ensino do país.";i="Saiba mais sobre a Lei 12.244/10, que garante o direito a biblioteca em todas as instituições de ensino do país. http://goo.gl/8oO9u8";break;case 2:s="Saiba porque é tão importante ter biblioteca nas escolas.";i="Saiba porque é tão importante ter biblioteca nas escolas http://goo.gl/8oO9u8";break}}});if(r.is(".facebook")){FB.ui({method:"feed",link:CURRENT_HOST,description:s},function(e){})}else if(r.is(".google")){var u="https://plus.google.com/share?url="+e;window.open(u,"_blank")}else if(r.is(".twitter")){var u=["http://twitter.com/home?status=",encodeURIComponent(i)].join("");window.open(u,"_blank")}});return false},bindScroll:function(){var e=window,t=document,n,r=this;var i=$("[data-scroll-event]");r.targetedElements=[];$(e).on("scroll",function(e){n=$(t).scrollTop();i.each(function(e,t){t=$(t);var i=t.attr("id");var s=t.offset().top+t.outerHeight(),o=n>=t.offset().top&&n<=s;if(n>=t.offset().top&&($.inArray(i,r.targetedElements)==-1||t.data("force")==true&&o)){if($.inArray(i,r.targetedElements)==-1){r.targetedElements.push(i)}var u=t.data("scroll-event");r[u].call(this)}})})},setMap:function(){var e=this;var t={center:new google.maps.LatLng(-23.591957,-46.642113),zoom:10,minZoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:false,scrollwheel:false};var n=new google.maps.LatLngBounds(new google.maps.LatLng(-30.08649256719401,-72.44996435546875),new google.maps.LatLng(1.0666086607317062,-37.837531249999984));e.map=new google.maps.Map(document.getElementById("search_map"),t);google.maps.event.addListener(e.map,"dragend",function(){if(n.contains(e.map.getCenter()))return;var t=e.map.getCenter(),r=t.lng(),i=t.lat(),s=n.getNorthEast().lng(),o=n.getNorthEast().lat(),u=n.getSouthWest().lng(),a=n.getSouthWest().lat();if(r<u)r=u;if(r>s)r=s;if(i<a)i=a;if(i>o)i=o;e.map.setCenter(new google.maps.LatLng(i,r))});e.infoWindows=[];e.markers=[];e.setMarkers();e.createMarkersCluster()},clearMarkers:function(){this.markerCluster.clearMarkers()},getMarkersJSON:function(e){var t=this;if(t.libraries_data!=undefined){return e.call(this,t.libraries_data)}else{$.getJSON("/api/libraries/?f=1",function(n){if(n.success&&n.total_records>0){t.initialMarkers=n.libraries;t.libraries_data=n}return e.call(this,n)})}},setMarkers:function(e){var t=this,n="/public/assets/images/markers",r={1:[n,"marker_people-mobilized.png"].join("/"),2:[n,"marker_institutions.png"].join("/"),3:[n,"marker_parliamentarians-candidates.png"].join("/")};t.initialMarkers=[];t.getCurrentLocation();var i="<span class='name'>#name</span><br />         <span class='occupation'>#occupation</span><br /><br />         <span class='text'>Reinvindica uma biblioteca para:</span><br /><br />         <span class='institucion_name'>#institution_name</span><br />         <span class='address'>#address</span>";var s=function(e,n){var s=new google.maps.Marker({position:e,map:t.map,title:n.name,icon:r[n.type],__type:n.type,__id:n._id});var o=i.replace("#name",n.name).replace("#occupation",n.occupation).replace("#institution_name",n.institution_name).replace("#address",[n.address.city.name,n.address.state.uf].join(" - "));o=["<div class='marker'><div class='marker-inner'>",o,"</div></div>"].join("");var u=new google.maps.InfoWindow({position:s.getPosition(),width:"200px",height:"200px"});google.maps.event.addListener(s,"click",function(){u.open(t.map,s);u.setContent(o)});t.markers.push(s);t.infoWindows.push(u)};var o=[],u=new google.maps.Geocoder;t.getMarkersJSON(function(e){if(e&&e.success){$.each(e.libraries,function(e,t){var n=t.address,r=n&&n.coordinates&&n.coordinates.lat&&n.coordinates.lng?n.coordinates:null;if(r){var i=new google.maps.LatLng(r.lat,r.lng);s(i,t)}else{o.push(t)}});$.each(o,function(e){var t=o[e],n=t.address.formatted_address||t.address.user_address;u.geocode({address:n},function(e,n){if(n=="OK"&&e&&e.length>0){var r=e[0],i=r.geometry.location,o=new google.maps.LatLng(i.d||i.lat,i.e||i.lng);s(o,t)}})});t.createMarkersCluster(t.markers)}});$("#markers-nav").on("click","li",function(){var e=$(this),n=e.data("type");$.each(ecoFuturoApp.infoWindows,function(e,t){t.close()});var r=t.markers,i=[];t.clearMarkers();t.markers=r;$.each(t.markers,function(e,t){if(t.__type==n){i.push(t)}});t.createMarkersCluster(i)})},createMarkersCluster:function(e){var t=this;return t.markerCluster=new MarkerClusterer(t.map,e)},getCurrentLocation:function(){var e=this;try{navigator.geolocation.getCurrentPosition(function(t){if(t&&t.coords){var n=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);e.map.setCenter(n);e.map.setZoom(10)}})}catch(t){}},updateCounters:function(){var e=$(".results-counts .counter[data-value]"),t={},n=[];e.each(function(e,r){r=$(r);var i=parseFloat(r.data("value").toString().replace(/[\.,\,]/g,""));t[r.attr("id")]=i;n.push(i)});if($(window).width()<768){e.each(function(e,n){n=$(n);n.html(t[n.attr("id")])})}else{var r=Math.max.apply(null,n),i=0;var s=setInterval(function(){e.each(function(e,n){n=$(n);i=parseFloat(n.text());var o=t[n.attr("id")];if(i<o){i=i+parseInt(15*Math.random());n.html(i>o?o:i)}if(i>=r){clearInterval(s)}})},1)}},fixMenu:function(){if($(window).width()>=1024){$(this).css({position:"fixed",top:"0",left:"0","z-index":"1900"})}$(".parallax").scrolly()},showGoTopButton:function(){var e=ecoFuturoApp;if($(window).width()>540){$("button#go-top").fadeIn(function(){$(this).on("click",function(){e.scrollTo("#home",null,function(){$("html, body").finish()})})})}},hideGoTopButton:function(){$("button#go-top").fadeOut()},trackPageview:function(){ecoFuturoApp.addGAEvent({type:"pageview",data:{page:$(this).data("ga-page")}})},dFieldLibrary:function(e){var t=e.value;if(t==2){$("#field-library-institution-name").css("display","none")}else{$("#field-library-institution-name").css("display","block")}},clickSignup:function(){$("#cad-signup").click()}};ecoFuturoApp.init()})