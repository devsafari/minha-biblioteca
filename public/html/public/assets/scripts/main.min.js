var ecoFuturoApp;$(document).ready(function(){"use strict";ecoFuturoApp={init:function(){var a=this;this.setMap(),this.bindEvents(),this.bindScroll(),this.bindForms(),this.fixBugs(),$("[data-modal]").on("click",function(b){b.preventDefault();var c=$(this).data("modal-target");a.showModal(c)})},fixBugs:function(){navigator.userAgent.match(/win(dows?)/gi)&&(s=document.createElement("style"),s.innerHTML="section#home .header .text-header,section.section>article>header>h1{font-family:open_sansbold,sans-serif}section#sobre-o-projeto .box-about{font-family:open_sansbold,sans-serif}section#sobre-o-projeto article#boxes-wrapper .boxes .box header{font-family:open_sansbold,sans-serif}#oriente-se .boxes,.button,section#resultados .results-wrapper ul.results-counts li,section#resultados .results-wrapper ul.results-counts li.header{font-family:open_sansbold,sans-serif}footer.footer .footer-section section header>*{text-align:left;font-family:open_sansbold,sans-serif}.form .radio-wrapper label{top:1px;left:1px;right:1px;bottom:1px;cursor:pointer;font-family:open_sansbold,sans-serif}#signup_form .signup-steps-wrapper .signup_form .submit-field .back-button,#signup_form .signup-steps-wrapper .signup_form .submit-field input[type=submit],#signup_form>header>h1,.form .field-wrapper input[type=submit],.section.contact .contact-form-wrapper header{font-family:open_sansbold,sans-serif}",$("head").append(s))},showModal:function(a){var b=this,c=$("#modal"),d=c.width();b.setBGMask(!0,0,"#modal"),c.css({width:d+"px",left:"50%","margin-left":-(d/2)+"px"}),$(".modal-content .inner-content").hide(function(){$(a).show(),c.fadeIn(function(){b.scrollTo(c,void 0,function(){$("body,html").finish()})})})},bindForms:function(){var a=this;this.submitForm("#new_library_form",{success:function(a){$(a).slideUp(),$("#signup_step_3").slideDown()},error:function(){}},!0,void 0,!1),this.submitForm("#contact_form",{success:function(){$("#contact_section").slideUp().remove()},error:function(){}},!0),$("#search_query").on("keydown",function(){""==$(this).val()&&(a.clearMarkers(),a.createMarkersCluster(a.markers))}),this.submitForm("#search_form",{success:function(b,c){if(c.success&&c.total_records>0){var d,e=[],f=$.map(c.libraries,function(a){return a._id});$.each(a.markers,function(a,b){var c=-1!=f.indexOf(b.__id);c&&e.push(b),c&&!d&&(d=b)});var g=a.markers;a.clearMarkers(),a.markers=g,a.createMarkersCluster(e),d&&(a.map.setCenter(d.position),a.map.setZoom(4)),a.setBGMask(!1)}else a.showNotification({message:"Nenhuma biblioteca encontrada para sua busca",header:"Opss :("},"error")},error:function(b,c){var d={message:c.errors.query,header:"Erro na busca"};a.showNotification(d,"error")}})},setBGMask:function(a,b,c){var d=$("#background-mask"),e=a?"fadeIn":"fadeOut";return d.attr("data-target",c),"fadeOut"==e&&$("#modal").hide(),d.delay(b||0)[e].call(d,"fast")},submitForm:function(a,b,c,d,e){var f=this;$(a).on("submit",function(a){a.preventDefault();var g=$(this),h=d||g.attr("method")||"POST";$.ajax({url:$(g).attr("action"),data:$(g).serialize(),type:h,dataType:"json",success:function(a){if(a.success?b.success&&b.success(g,a):a.error&&b.error&&b.error(g,a),c){if(a.error){if("object"==typeof a.errors)var d=Object.keys(a.errors).map(function(b){return a.errors[b]}),e=d.map(function(a){return"<li>"+a+"</li>"}).join("");else e=a.message;a.message=["<ul class='errors-messages'>",e,"</li>"].join(""),a.header="Opss"}else a.success&&(a.header="Sucesso!");var h=a.error?"error":"success";f.showNotification(a,h)}},fail:function(){f.showNotification({message:"Um erro ocorreu em nossos servidores. Por favor, tente novamente ou volte mais tarde.",header:"Erro interno"},"error",!0)},complete:function(){e!==!1&&f.setBGMask(!1,2e3)},beforeSend:function(){f.setBGMask(!0)}})})},showNotification:function(a,b,c){var d=this;d.formLogger=$("#form-logger"),d.formLogger.removeAttr("class"),d.formLogger.addClass(b),d.formLogger.find(".message-header").html(a.header),d.formLogger.find(".message-body").html(a.message),d.formLogger.css({"margin-top":-(d.formLogger.height()/2)+"px","margin-left":-(d.formLogger.width()/2)+"px",position:"fixed"}),d.formLogger.fadeIn().animate({top:"50%",opacity:"1"},function(){setTimeout(function(){d.formLogger.animate({top:"-50%"},function(){$(this).css({"margin-top":"0"}).fadeOut("fast")})},c||1e3)})},bindEvents:function(){var a=this;this.bindShareEvents(),$(".scroll-button").on("click",function(b){b.preventDefault();var c=$(this).data("target");a.scrollTo(c)});var b=function(){$("#video").css({width:$(window).innerWidth()+"px",height:$(window).innerHeight()+"px"})};b(),$(window).resize(function(){b()});var c=$("#preview-video-wrapper");1==$.browser.mobile&&c.remove(),$("#video-play").on("click",function(){var a=$(this),b=$("#video");a.fadeOut("slow");var d=b.attr("src");b.attr("src",d+"&autoplay=1"),$(".text-header,.share-text,.down-button","#home").delay(200).fadeOut("fast",function(){$("#video-wrapper").fadeIn(function(){c.size()>0&&c.fadeOut()})})}),$("#background-mask").on("click",function(){var b=$($(this).data("target"));a.setBGMask(!1),b.fadeOut()}),this.bindMenu(),this.bindContactForm(),this.bindBoxes(),this.bindSignupForm()},bindMenu:function(){var a=this;$("#main-menu, #footer-links").on("click","li > a",function(){a.scrollTo($(this).attr("href"),500)})},bindContactForm:function(){var a=this,b=$("#contact_form .step").size();a.contactStep=1,$(".contact-form-toggle").on("click",function(b){b.preventDefault();var c=$("#contact_section");c.slideToggle();var d=$(".step#step_"+a.contactStep);d.fadeIn(),a.scrollTo(c)});var c=function(){var c=$(".step#step_"+a.contactStep);c.fadeOut(function(){var c=$(".step#step_"+(a._previousContact?--a.contactStep:++a.contactStep));c.size()>0&&(a._previousContact?a.contactStep>1:a.contactStep<=b)&&(c.fadeIn(),a._previousContact=!1)})};$(".step input[type='radio']").on("change",function(){c()}),$(".contact-form-wrapper #back-btn").on("click",function(b){return b.preventDefault(),1==a.contactStep?!1:(a._previousContact=!0,c(),void 0)})},bindSignupForm:function(){var a=this,b=$("#signup_form");$("button.signup, a.signup").on("click",function(){a.setBGMask(!0,null,"#signup_form"),a.scrollTo("#map-wrapper",void 0,function(){$("#new_library_form").fadeIn(),$("#signup_step_3").fadeOut(),b.slideDown("fast")})}),$("#signup_step_1").on("change",'input[type="radio"]',function(){var b=$("#signup_type"),c=$(this),d=c.data("header"),e=c.val();b.html()!=d&&b.html(d),$("[class*='signup_type_']","#signup_form").hide(),$(".signup_type_"+e).show()});var c=$("#autocomplete-wrapper"),d=$("#autocomplete-results",c),e=!1;d.hover(function(){e=!0},function(){e=!1}),$(d).on("click","li",function(){var a=$(this);$("#library_institution_name").val(a.data("value")),$("#library_school_id").val(a.data("id")),d.fadeOut("fast"),$("#signup_form").removeClass("autocomplete-opened")});var f=function(){d.children("li").remove()},g=function(a){var b=$("#signup_form"),c="autocomplete-opened";if(f(),a&&a.success&&a.count>0){b.addClass(c),d.fadeIn();var e=$(document.createDocumentFragment());$.each(a.schools,function(a,b){var c=[b.name," - ",b.address.street,", ",b.address.district.name].join(""),d=$(document.createElement("li")).attr({"data-id":b._id,"data-value":b.name});$("<span />",{"class":"value",html:c}).appendTo(d),e.append(d)}),d.append(e)}else d.hide(),b.removeClass(c)},h={};$("#library_institution_name").on("blur",function(){return e?!1:($("#signup_form").removeClass("autocomplete-opened"),d.fadeOut(),void 0)}),$("#library_institution_name").on("change keyup",function(){var b=$(this),c=b.val(),d=$("select#library_state").val(),e=$("select#library_city").val();if(!d)return a.showNotification({message:"Voc\xea deve selecionar o estado e a cidade antes de pesquisar a escola.",header:"Ops..."},"error",2e3);if(!e)return a.showNotification({message:"Voc\xea deve selecionar uma cidade antes de pesquisar a escola",header:"Ops..."},"error",1600);if(c.length>3){var i=[d,e,c].join("_");h[i]?g(h[i]):$.get("/api/schools/autocomplete",{city:e,state:d,name:c},function(a){h[i]=a,g(a)},"json")}else f()}),$("#signup_step_1 input[type='radio']:checked").change(),new dgCidadesEstados({estado:$(b).find(".state-select").get(0),cidade:$(b).find(".city-select").get(0)})},bindBoxes:function(){var a=$("#boxes-wrapper"),b=$("#boxes_nav"),c=$("#arrow_nav"),d=$("#text-slide-wrapper"),e=0;b.on("click","li",function(){var a=$(this).index();f(a),clearInterval(h)});var f=function(a){$("li",b).removeClass("current"),$("li",b).eq(a).addClass("current");var c=$("#slide-texts li.current").outerHeight();d.css({height:c+"px"}),$("#slide-texts").css("position","relative").animate({top:-(a*c)},200)},g=function(){f(e++),e>=3&&(e=0)};f(b.find("li:first").index());var h=setInterval(g,8e3);$(".box",a).on("click",function(){var b=$(this),d=b.index();if(b.hasClass("opened"))return!1;var e=$(".opened",a);e.removeClass("opened"),$(this).addClass("opened");var f=["15%","50%","85%"];c.animate({left:f[d]},function(){var a=$("#box-desc-contents > ul.contents").find("> li").get(d);$("#desc-content").html($(a).html())})}),$(".box.first").click()},scrollTo:function(a,b,c){var d=Math.max.apply(Math,[$(a).offset().top-170,0]);$("html, body").animate({scrollTop:d},void 0==b?1e3:b,void 0==c?function(){}:c)},bindShareEvents:function(){$(".facebook-share").on("click",function(a){a.preventDefault(),FB.ui({method:"feed",link:"http://www.euquerominhabiblioteca.org.br/"},function(){})}),$("nav.banners .banner").on("click","a",function(a){a.preventDefault();var b=$(this);$("article.embed-code").slideDown("fast",function(){$("#embed_code").html(b.parent("li").html().trim())})});var a="http://goo.gl/8oO9u8";return $("#boxes-wrapper .share-icons").on("click","a",function(b){b.preventDefault();var c="",d=$(this).parent("li"),e="",f="";$("#desc-content ul > li").each(function(a,b){c+=$(b).text().trim()+" "}),c=c.replace(/\n/g,"").replace(/\s{5,}/g,"");var g=$(this).parents("#boxes-wrapper");if(g.find(".boxes li").each(function(a){if($(".boxes li").eq(a).hasClass("opened"))switch(a){case 0:f="Conhe\xe7a mais sobre os objetivos da campanha Eu Quero Minha Biblioteca.",e="Conhe\xe7a mais sobre os objetivos da campanha Eu Quero Minha Biblioteca em http://goo.gl/8oO9u8";break;case 1:f="Saiba mais sobre a Lei 12.244/10, que garante o direito a biblioteca em todas as institui\xe7\xf5es de ensino do pa\xeds.",e="Saiba mais sobre a Lei 12.244/10, que garante o direito a biblioteca em todas as institui\xe7\xf5es de ensino do pa\xeds. http://goo.gl/8oO9u8";break;case 2:f="Saiba porque \xe9 t\xe3o importante ter biblioteca nas escolas.",e="Saiba porque \xe9 t\xe3o importante ter biblioteca nas escolas http://goo.gl/8oO9u8"}}),d.is(".facebook"))FB.ui({method:"feed",link:"http://www.euquerominhabiblioteca.org.br/",description:f},function(){});else if(d.is(".google")){var h="https://plus.google.com/share?url="+a;window.open(h,"_blank")}else if(d.is(".twitter")){var h=["http://twitter.com/home?status=",encodeURIComponent(e)].join("");window.open(h,"_blank")}}),!1},bindScroll:function(){var c,a=window,b=document,d=this,e=$("[data-scroll-event]");d.targetedElements=[],$(a).on("scroll",function(){c=$(b).scrollTop(),e.each(function(a,b){b=$(b);var e=b.attr("id"),f=b.offset().top+b.outerHeight(),g=c>=b.offset().top&&f>=c;if(c>=b.offset().top&&(-1==$.inArray(e,d.targetedElements)||1==b.data("force")&&g)){-1==$.inArray(e,d.targetedElements)&&d.targetedElements.push(e);var h=b.data("scroll-event");d[h].call(this)}})})},setMap:function(){var a=this,b={center:new google.maps.LatLng(-23.591957,-46.642113),zoom:10,minZoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!1,scrollwheel:!1},c=new google.maps.LatLngBounds(new google.maps.LatLng(-30.08649256719401,-72.44996435546875),new google.maps.LatLng(1.0666086607317062,-37.837531249999984));a.map=new google.maps.Map(document.getElementById("search_map"),b),google.maps.event.addListener(a.map,"dragend",function(){if(!c.contains(a.map.getCenter())){var b=a.map.getCenter(),d=b.lng(),e=b.lat(),f=c.getNorthEast().lng(),g=c.getNorthEast().lat(),h=c.getSouthWest().lng(),i=c.getSouthWest().lat();h>d&&(d=h),d>f&&(d=f),i>e&&(e=i),e>g&&(e=g),a.map.setCenter(new google.maps.LatLng(e,d))}}),a.infoWindows=[],a.markers=[],a.setMarkers(),a.createMarkersCluster()},clearMarkers:function(){this.markerCluster.clearMarkers()},getMarkersJSON:function(a){var b=this;return void 0!=b.libraries_data?a.call(this,b.libraries_data):($.getJSON("/api/libraries/?f=1",function(c){return c.success&&c.total_records>0&&(b.initialMarkers=c.libraries,b.libraries_data=c),a.call(this,c)}),void 0)},setMarkers:function(){var b=this,c="/public/assets/images/markers",d={1:[c,"marker_people-mobilized.png"].join("/"),2:[c,"marker_institutions.png"].join("/"),3:[c,"marker_parliamentarians-candidates.png"].join("/")};b.initialMarkers=[],b.getCurrentLocation();var e="<span class='name'>#name</span><br />         <span class='occupation'>#occupation</span><br /><br />         <span class='text'>Reinvindica uma biblioteca para:</span><br /><br />         <span class='institucion_name'>#institution_name</span><br />         <span class='address'>#address</span>",f=function(a,c){var f=new google.maps.Marker({position:a,map:b.map,title:c.name,icon:d[c.type],__type:c.type,__id:c._id}),g=e.replace("#name",c.name).replace("#occupation",c.occupation).replace("#institution_name",c.institution_name).replace("#address",[c.address.city.name,c.address.state.uf].join(" - "));g=["<div class='marker'><div class='marker-inner'>",g,"</div></div>"].join("");var h=new google.maps.InfoWindow({position:f.getPosition(),width:"200px",height:"200px"});google.maps.event.addListener(f,"click",function(){h.open(b.map,f),h.setContent(g)}),b.markers.push(f),b.infoWindows.push(h)},g=[],h=new google.maps.Geocoder;b.getMarkersJSON(function(a){a&&a.success&&($.each(a.libraries,function(a,b){var c=b.address,d=c&&c.coordinates&&c.coordinates.lat&&c.coordinates.lng?c.coordinates:null;if(d){var e=new google.maps.LatLng(d.lat,d.lng);f(e,b)}else g.push(b)}),$.each(g,function(a){var b=g[a],c=b.address.formatted_address||b.address.user_address;h.geocode({address:c},function(a,c){if("OK"==c&&a&&a.length>0){var d=a[0],e=d.geometry.location,g=new google.maps.LatLng(e.d||e.lat,e.e||e.lng);f(g,b)}})}),b.createMarkersCluster(b.markers))}),$("#markers-nav").on("click","li",function(){var a=$(this),c=a.data("type");$.each(ecoFuturoApp.infoWindows,function(a,b){b.close()});var d=b.markers,e=[];b.clearMarkers(),b.markers=d,$.each(b.markers,function(a,b){b.__type==c&&e.push(b)}),b.createMarkersCluster(e)})},createMarkersCluster:function(a){var b=this;return b.markerCluster=new MarkerClusterer(b.map,a)},getCurrentLocation:function(){var a=this;try{navigator.geolocation.getCurrentPosition(function(b){if(b&&b.coords){var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);a.map.setCenter(c),a.map.setZoom(10)}})}catch(b){}},updateCounters:function(){var a=$(".results-counts .counter[data-value]"),b={},c=[];if(a.each(function(a,d){d=$(d);var e=parseFloat(d.data("value").toString().replace(/[\.,\,]/g,""));b[d.attr("id")]=e,c.push(e)}),$(window).width()<768)a.each(function(a,c){c=$(c),c.html(b[c.attr("id")])});else var d=Math.max.apply(null,c),e=0,f=setInterval(function(){a.each(function(a,c){c=$(c),e=parseFloat(c.text());var g=b[c.attr("id")];g>e&&(e+=parseInt(15*Math.random()),c.html(e>g?g:e)),e>=d&&clearInterval(f)})},1)},fixMenu:function(){$(window).width()>=1024&&$(this).css({position:"fixed",top:"0",left:"0","z-index":"1900"}),$(".parallax").scrolly()},showGoTopButton:function(){var a=ecoFuturoApp;$(window).width()>540&&$("button#go-top").fadeIn(function(){$(this).on("click",function(){a.scrollTo("#home",null,function(){$("html, body").finish()})})})},hideGoTopButton:function(){$("button#go-top").fadeOut()},dFieldLibrary:function(a){var b=a.value;2==b?$("#field-library-institution-name").css("display","none"):$("#field-library-institution-name").css("display","block")},clicSignup:function(){$("#cad-signup").click()}},ecoFuturoApp.init()});
